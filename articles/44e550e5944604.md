---
title: "vldã‚’ä½¿ã£ã¦PHPã®opcodeã‚’å‡ºåŠ›ã™ã‚‹"
emoji: "ğŸ‘Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["PHP"]
published: false
---

VLD (Vulcan Logic Disassembler) ã¯ã€PHPã®opcodeã‚’ã€ãƒ€ãƒ³ãƒ—ã—ã¦ãã‚Œã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
VLDã‚’ä½¿ã£ã¦opcodeã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ã§ã€PHPã®æ§‹æ–‡è§£æãŒã©ã®ã‚ˆã†ã«è¡Œã‚ã‚Œã¦ã„ã‚‹ã‹ã‚’ç†è§£ã™ã‚‹åŠ©ã‘ã«ãªã‚Šã¾ã™ã€‚

ä»Šå›ã¯Dockerã‚’ä½¿ã£ã¦VLDã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã€PHPã‚¹ã‚¯ãƒªãƒ—ãƒˆã®opcodeã‚’å‡ºåŠ›ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ–¹æ³•

```docker-compose.yml
services:
  php-vld:
    build: .
    volumes:
      - ./scripts:/app/scripts
    tty: true
    stdin_open: true
```

```Dockerfile
FROM php:8.4-cli

# Install VLD extension
RUN pecl install channel://pecl.php.net/vld-0.19.1 && \
    docker-php-ext-enable vld

# Set working directory
WORKDIR /app

# Keep container running
CMD ["tail", "-f", "/dev/null"]
```

## ä½¿ç”¨æ–¹æ³•

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

æ¤œè¨¼ã—ãŸã„PHPã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’`./scripts`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹æˆã«ãªã‚Šã¾ã™ã€‚

```
.
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ scripts
    â”œâ”€â”€ test.php
    â”œâ”€â”€ test2.php
    â””â”€â”€ test3.php
```

```php:scripts/test.php
<?php
echo 'Hello World!' . PHP_EOL;
```

### å®Ÿè¡Œ

```bash
docker compose run --rm php-vld \
php -d vld.active=1 -d vld.execute=0 \
/app/scripts/test.php
```

`php` ã®ã‚ã¨ã® `-d vld.active=1` ã¯VLDã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã€`-d vld.execute=0` ã¯å®Ÿè¡Œã‚’ç„¡åŠ¹ã«ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€PHPã‚¹ã‚¯ãƒªãƒ—ãƒˆã®opcodeãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚
`-d vld.execute=1` ã¨ã™ã‚‹ã¨ã€opcodeã®å‡ºåŠ›ã®å¾Œã«ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œã‚‚è¡Œã‚ã‚Œã¾ã™ã€‚

```txt:å‡ºåŠ›çµæœ
Finding entry points
Branch analysis from position: 0
1 jumps found. (Code = 62) Position 1 = -2
filename:       /app/scripts/test.php
function name:  (null)
number of ops:  2
compiled vars:  none
line      #* E I O op                               fetch          ext  return  operands
-----------------------------------------------------------------------------------------
    2     0  E >   ECHO                                                         'Hello+World%21%0A'
          1      > RETURN                                                       1

branch: #  0; line:     2-    2; sop:     0; eop:     1; out0:  -2
path #1: 0,
```

`'Hello+World%21%0A'` ã¨è¨€ã†ã‚ªãƒšãƒ©ãƒ³ãƒ‰ã«å¯¾ã—ã¦ã€ `ECHO` ã¨ã„ã†ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

## ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¨å®Ÿè¡Œçµæœã®ä¾‹

### 1. æ¡ä»¶åˆ†å²ã®ä¾‹

```php
<?php

if(mt_rand(1,6) % 2 === 0){
    echo 'cho';
}else{
    echo 'han';
}
```

```txt:å‡ºåŠ›çµæœ
Finding entry points
Branch analysis from position: 0
2 jumps found. (Code = 43) Position 1 = 7, Position 2 = 9
Branch analysis from position: 7
1 jumps found. (Code = 42) Position 1 = 10
Branch analysis from position: 10
1 jumps found. (Code = 62) Position 1 = -2
Branch analysis from position: 9
1 jumps found. (Code = 62) Position 1 = -2
filename:       /app/scripts/test.php
function name:  (null)
number of ops:  11
compiled vars:  none
line      #* E I O op                               fetch          ext  return  operands
-----------------------------------------------------------------------------------------
    3     0  E >   INIT_FCALL                                                   'mt_rand'
          1        SEND_VAL                                                     1
          2        SEND_VAL                                                     6
          3        DO_ICALL                                             $0      
          4        MOD                                                  ~1      $0, 2
          5        IS_IDENTICAL                                                 ~1, 0
          6      > JMPZ                                                         ~2, ->9
    4     7    >   ECHO                                                         'cho'
    3     8      > JMP                                                          ->10
    6     9    >   ECHO                                                         'han'
    7    10    > > RETURN                                                       1

branch: #  0; line:     3-    3; sop:     0; eop:     6; out0:   7; out1:   9
branch: #  7; line:     4-    3; sop:     7; eop:     8; out0:  10
branch: #  9; line:     6-    7; sop:     9; eop:     9; out0:  10
branch: # 10; line:     7-    7; sop:    10; eop:    10; out0:  -2; out1:  -2
path #1: 0, 7, 10, 
path #2: 0, 9, 10,
```

### 2. é–¢æ•°ã®ä¾‹

```php
<?php
function greet($name) {
    echo "Hello, $name!";
}
greet("Alice");
```

```txt:å‡ºåŠ›çµæœ
Finding entry points
Branch analysis from position: 0
1 jumps found. (Code = 62) Position 1 = -2
filename:       /app/scripts/test.php
function name:  (null)
number of ops:  4
compiled vars:  none
line      #* E I O op                               fetch          ext  return  operands
-----------------------------------------------------------------------------------------
    5     0  E >   INIT_FCALL                                                   'greet'
          1        SEND_VAL                                                     'Alice'
          2        DO_FCALL                                          0          
    6     3      > RETURN                                                       1

branch: #  0; line:     5-    6; sop:     0; eop:     3; out0:  -2
path #1: 0, 
Function greet:
Finding entry points
Branch analysis from position: 0
1 jumps found. (Code = 62) Position 1 = -2
filename:       /app/scripts/test.php
function name:  greet
number of ops:  6
compiled vars:  !0 = $name
line      #* E I O op                               fetch          ext  return  operands
-----------------------------------------------------------------------------------------
    2     0  E >   RECV                                                 !0      
    3     1        ROPE_INIT                                         3  ~2      'Hello%2C+'
          2        ROPE_ADD                                          1  ~2      ~2, !0
          3        ROPE_END                                          2  ~1      ~2, '%21'
          4        ECHO                                                         ~1
    4     5      > RETURN                                                       null

branch: #  0; line:     2-    4; sop:     0; eop:     5; out0:  -2
path #1: 0, 
End of function greet
```
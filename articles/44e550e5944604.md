---
title: "vldを使ってPHPのopcodeを出力する"
emoji: "👌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["PHP"]
published: false
---

VLD (Vulcan Logic Disassembler) は、PHPのopcodeを、ダンプしてくれるツールです。今回はDockerを使ってVLDをセットアップして、PHPスクリプトのopcodeを出力する方法を紹介します。

## インストール方法

```docker-compose.yml
services:
  php-vld:
    build: .
    volumes:
      - ./scripts:/app/scripts
    tty: true
    stdin_open: true
```

```Dockerfile
FROM php:8.4-cli

# Install VLD extension
RUN pecl install channel://pecl.php.net/vld-0.19.1 && \
    docker-php-ext-enable vld

# Set working directory
WORKDIR /app

# Keep container running
CMD ["tail", "-f", "/dev/null"]
```

## 使用方法

### ディレクトリ構成

検証したいPHPスクリプトを`./scripts`ディレクトリに配置します。例えば、以下のような構成になります。

```
.
├── Dockerfile
├── docker-compose.yml
└── scripts
    ├── test.php
    ├── test2.php
    └── test3.php
```

```php:scripts/test.php
<?php
echo 'Hello World!' . PHP_EOL;
```

### 実行コマンド

```bash
docker compose run --rm php-vld \
php -d vld.active=1 -d vld.execute=0 \
/app/scripts/test.php
```

```txt:出力結果
Finding entry points
Branch analysis from position: 0
1 jumps found. (Code = 62) Position 1 = -2
filename:       /app/scripts/test.php
function name:  (null)
number of ops:  2
compiled vars:  none
line      #* E I O op                               fetch          ext  return  operands
-----------------------------------------------------------------------------------------
    2     0  E >   ECHO                                                         'Hello+World%21%0A'
          1      > RETURN                                                       1

branch: #  0; line:     2-    2; sop:     0; eop:     1; out0:  -2
path #1: 0,
```